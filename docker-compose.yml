version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: vpp_mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: vpp_platform
    volumes:
      - mongodb_data:/data/db
    networks:
      - vpp_network

  # Redis Cache & Pub/Sub
  redis:
    image: redis:7-alpine
    container_name: vpp_redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - vpp_network

  # MQTT Broker (Mosquitto)
  mqtt_broker:
    image: eclipse-mosquitto:2
    container_name: vpp_mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./docker/mosquitto/config:/mosquitto/config
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    networks:
      - vpp_network

  # Express.js Backend (Aggregator Core)
  aggregator_backend:
    build:
      context: ./backend_express
      dockerfile: Dockerfile
    container_name: vpp_aggregator
    ports:
      - "3000:3000"
      - "3001:3001"
    environment:
      PORT: 3000
      WS_PORT: 3001
      NODE_ENV: development
      MONGODB_URI: mongodb://mongodb:27017/vpp_platform
      MONGODB_DB_NAME: vpp_platform
      REDIS_HOST: redis
      REDIS_PORT: 6379
      MQTT_BROKER_URL: mqtt://mqtt_broker:1883
      CORS_ORIGIN: http://localhost:5173
      AUTH0_DOMAIN: ${AUTH0_DOMAIN}
      AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
      AUTH0_ISSUER: ${AUTH0_ISSUER}
    depends_on:
      - mongodb
      - redis
      - mqtt_broker
    volumes:
      - ./backend_express:/app
      - /app/node_modules
    networks:
      - vpp_network

  # FastAPI Edge Node 1
  edge_node_1:
    build:
      context: ./services/edge_node
      dockerfile: Dockerfile
    container_name: vpp_edge_node_1
    ports:
      - "8001:8000"
    environment:
      DC_ID: DC01
      PORT: 8000
      MQTT_ENABLED: "true"
      MQTT_BROKER_URL: mqtt://mqtt_broker:1883
      AGGREGATOR_URL: http://aggregator_backend:3000
      TELEMETRY_INTERVAL: 5
    depends_on:
      - mqtt_broker
      - aggregator_backend
    networks:
      - vpp_network

  # FastAPI Edge Node 2
  edge_node_2:
    build:
      context: ./services/edge_node
      dockerfile: Dockerfile
    container_name: vpp_edge_node_2
    ports:
      - "8002:8000"
    environment:
      DC_ID: DC02
      PORT: 8000
      MQTT_ENABLED: "true"
      MQTT_BROKER_URL: mqtt://mqtt_broker:1883
      AGGREGATOR_URL: http://aggregator_backend:3000
      TELEMETRY_INTERVAL: 5
    depends_on:
      - mqtt_broker
      - aggregator_backend
    networks:
      - vpp_network

  # React Web Dashboard
  web_dashboard:
    build:
      context: ./web_dashboard
      dockerfile: Dockerfile.dev
    container_name: vpp_web_dashboard
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:3000
      VITE_WS_URL: ws://localhost:3001
      VITE_AUTH0_DOMAIN: ${AUTH0_DOMAIN}
      VITE_AUTH0_CLIENT_ID: ${AUTH0_CLIENT_ID}
      VITE_AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
    volumes:
      - ./web_dashboard:/app
      - /app/node_modules
    depends_on:
      - aggregator_backend
    networks:
      - vpp_network

networks:
  vpp_network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  mqtt_data:
  mqtt_logs:
